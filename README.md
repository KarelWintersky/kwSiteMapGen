# Что это?

Генератор sitemap`ов для произвольного сайта.

# Особенности реализации

Все настройки подключения к БД указаны в файле `config.db.ini`. В репозитории есть пример этого файла: `config.db.ini.example`.

Предполагается, что конфиг-файлы недоступны посторонним, но я все равно рекомендую создать для генерации сайтмэпа отдельного
пользователя исключительно с правом SELECT (и, разумеется, прописать в `db.ini` соответствующие значения):

```
CREATE USER 'sitemapcreator'@'localhost' IDENTIFIED BY 'sitemappassword';
GRANT SELECT ON database.* TO `sitemapcreator`@`localhost`;
FLUSH PRIVELEGES;
```

Инструкции по построению сайтмапов для разных типов страниц задаются в файле `config.sitemap.ini`. Каждый тип страницы описывается в отдельной секции.
Информация о страницах может извлекаться как из БД (MySQL), так и из текстового файла.

Как писать этот конфиг?

# Настройка конфигурации

## Глобальные настройки
Они задаются в секции с именем `___GLOBAL_SETTINGS___`

```
[___GLOBAL_SETTINGS___]
; URL сайта (домен, включая финальный слэш)
sitehref = 'http://www.example.com/'

; где лежат файлы сайтмапов (разумеется, мы должны иметь права на запись в этот каталог)
; на данный момент "корневой" сайтмэп сохраняется в эту же папку
sitemaps_storage = '/var/www/example.com/sitemaps/'

; URL (включая домен и финальный слеш) к промежуточным файлам сайтмапов
sitemaps_href = 'http://www.example.com/sitemaps/'

; максимальное количество URL в файле sitemap
limit_urls = 50000

; максимальный размер промежуточного файла sitemap без сжатия
limit_bytes = 50000000

; использовать ли gzip для сжатия
use_gzip = 1

; выводить ли информацию о генерации файлов карт?
logging = 1

; формат представления даты. Допустимые значения:
;   iso8601 - дата в формате W3C Datetime (2004-12-23T18:00:15+00:00)
; * YMD - дата в формате Y-m-d (2004-12-23), этот формат используется по умолчанию (если опция не задана или содержит другое значение)
date_format_type = 'iso8601'
```

## Пример секции: данные о страницах берутся из БД

```
; название секции
[price]
; [ОБЯЗАТЕЛЬНАЯ ОПЦИЯ]
; источник данных - sql, file, csv
source = 'sql'

; [ОБЯЗАТЕЛЬНАЯ ОПЦИЯ]
; запрос к БД для получения количества элементов, для которых строим sitemap
sql_count_request = 'SELECT COUNT(id) AS cnt FROM price'

; [ОБЯЗАТЕЛЬНАЯ ОПЦИЯ]
; поле в результатах запроса, содержащее нужное количество
sql_count_value = 'cnt'

; [ОБЯЗАТЕЛЬНАЯ ОПЦИЯ]
; запрос к БД для получения всех нужных нам элементов (LIMIT ... OFFSET ... не указывать!)
sql_data_request = 'SELECT id, lastmod FROM price'

; [ОБЯЗАТЕЛЬНАЯ ОПЦИЯ]
; имя поля в результатах запроса, содержащее айди страницы
sql_data_id = 'id'

; [ОБЯЗАТЕЛЬНАЯ ОПЦИЯ]
; имя поля в результатах запроса, содержащее дату последней модификации 
; страницы. Используется для атрибута lastmod в sitemap-ссылке.
sql_data_lastmod = 'lastmod'

; [ОБЯЗАТЕЛЬНАЯ ОПЦИЯ]
; URL до страницы от корня сайта (исключая домен)
; используется как маска для sprintf
url_location = 'price/%s.html'

; [РЕКОМЕНДУЕМАЯ ОПЦИЯ]
; приоритет страниц в секции, по умолчанию 0.5
url_priority = '0.5'

; [РЕКОМЕНДУЕМАЯ ОПЦИЯ]
; вероятная частота обновления страниц в этой секции
; допустимые значения: always, hourly, daily, weekly, monthly, yearly, never
; значение по умолчанию: never
url_changefreq = 'daily'

; [НЕОБЯЗАТЕЛЬНАЯ ОПЦИЯ]
; корень имени файла, содержащего ссылки для страниц данной категории
; файлы будут иметь вид price-1, price-2 etc
; опцию можно опустить или оставить пустой - тогда имя файла будет таким же, как имя секции
radical = 'price'

; [НЕОБЯЗАТЕЛЬНАЯ ОПЦИЯ]
; использовать ли gzip-сжатие для файлов sitemap для данной секции. Перекрывает глобальное значение use_gzip
use_gzip = 0
```

### Важный момент №1 - Необычные запросы

запрос может быть и другим, к примеру
```
SELECT CONCAT('/page/xxx/', id) AS it, FORMAT_DATE(mask, lastdate) AS pld FROM price
```
тогда имена полей с данными должны быть `it` и `pld` соотв.

### Важный момент №2 - Условные операторы в запросе

Хотя задать условия выборки можно в опциях
```
sql_count_request = 'SELECT COUNT(id) AS cnt FROM price WHERE price.actual = 1'
sql_data_request = 'SELECT id, lastmod FROM price WHERE price.actual = 1'
```

...эффективнее будет использование **представления** (VIEW), к примеру:
```
CREATE VIEW actual_price
AS SELECT id, lastmod FROM price WHERE price.actual = 1;
```

Соответственно опции будут такими:
```
sql_count_request = 'SELECT COUNT(id) AS cnt FROM actual_price'
sql_data_request = 'SELECT id, lastmod FROM actual_price'
```

### Важный момент №3 - sort order

```
sql_data_request = 'SELECT id, lastmod FROM price ORDER BY lastmod DESC'
```
Это допустимая строчка. Но лучше тоже через **VIEW**.

## Пример секции: данные о страницах берутся из текстового файла

```
; страны-регионы
[countries]
; [НЕОБЯЗАТЕЛЬНАЯ ОПЦИЯ]
; корень имени файла, содержащего ссылки для страниц данной категории
; файлы будут иметь вид countries-1, countries-2 etc (см. separator в секции $GLOBAL_SETTINGS$)
radical = 'countries'

; [ОБЯЗАТЕЛЬНАЯ ОПЦИЯ]
; источник данных
source = 'file'

; [ОБЯЗАТЕЛЬНАЯ ОПЦИЯ]
; имя файла с данными построчно
filename = 'countries.txt'

; [ОБЯЗАТЕЛЬНАЯ ОПЦИЯ]
; URL до страницы от корня сайта (исключая домен)
; используется маска для sprintf
url_location = 'countries/%s/'

; [РЕКОМЕНДУЕМАЯ ОПЦИЯ]
; приоритет страниц в секции, по умолчанию 0.5
url_priority = '0.5'

; [РЕКОМЕНДУЕМАЯ ОПЦИЯ]
; вероятная частота обновления страниц в этой секции
; допустимые значения: always, hourly, daily, weekly, monthly, yearly, never
; значение по умолчанию: never
url_changefreq = 'daily'

; единственное допустимое значение. Означает, что для lastmod ссылки берется текущий таймштамп
lastmod = 'NOW()'
```

Примечание: можно в отладочных целях запретить обработку какой-то секции. Для этого надо указать в теле секции опцию:
```
enabled = 0
```
Любое другое значение или отсутствие этой строчки означает необходимость обработки секции.

# Запуск

"Точка входа" - `generate.php` или `sitemap_generator.php` (all-in-one версия).

Требуются файлы:
- `config.db.ini`
- `config.sitemap.ini`
- текстовые (или CSV) файлы с перечисленными статическими страницами (с данным sitemap-конфигом - `data.countries.txt` и `data.staticpages.txt`)


## Минифицированная версия

Собирается при помощи `sh`-скрипта `build_minified.sh`. Результирующий файл будет называться `sitemap_generator.php`.


# Todo
- Добавить источник данных: CSV с именованными столбцами.
- Определиться, как задавать lastmod для страниц/строк, описанных в файлах (как источниках данных). Сейчас NOW() означает текущий таймштамп.
- На данный момент "корневой" сайтмэп сохраняется в ту же папку, что и сайтмапы секций. Надо ли задавать иное поведение?
- На данный момент если во обёртку `SitemapFileSaver::push()` не передаётся дата последней модификации - используется текущий таймштамп. Надо ли менять это поведение?
- Определиться, нужно ли разрешить использовать индивидуальный `date_format_type` для каждой секции?

# Ссылки

- [Спецификация Sitemap](https://www.sitemaps.org/ru/protocol.html)
- [библиотека XMLWriter](http://php.net/manual/ru/book.xmlwriter.php) (на Gentoo требуется компиляция с флагом `+xmlwriter`
- [W3C Datetime Specification](https://www.w3.org/TR/NOTE-datetime)

# Совместимость

Тестировалось на PHP7+

